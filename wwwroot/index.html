<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>📚 Book Generator</title>
    <link rel="stylesheet" href="css/book-cover.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <style>
       
    </style>
</head>
<body>
    <h1 style="text-align: center;">
    Book Generator</h1>


    <div class="controls mb-4" style="margin-top: 30px;">
        <label>
            Language:
            <select id="region" class="form-select d-inline w-auto">
                <option value="es-ES">Español</option>
                <option value="tr-TR">Türkçe</option>
                <option value="en-US">English</option>
            </select>
        </label>

        <label>
            Seed:
            <input type="text" id="seed" class="form-control d-inline w-auto" value="HELLO" />
        </label>

        <label>
            Likes Avg:
            <input type="number" id="likesAvg" class="form-control d-inline w-auto" value="5" step="0.1" />
        </label>

        <label>
            Reviews Avg:
            <input type="number" id="reviewsAvg" class="form-control d-inline w-auto" value="1" step="0.1" />
        </label>

        <button id="generateBtn" class="btn btn-primary ms-3">
            <i class="fa-solid fa-bolt"></i> Generate
        </button>
    </div>

    <div id="results"></div>

    <script>
        let currentPage = 1;
        let isLoading = false;

        async function loadBooks() {
            if (isLoading) return;
            isLoading = true;

            const region = document.getElementById('region').value;
            const seed = document.getElementById('seed').value;
            const likesAvg = document.getElementById('likesAvg').value;
            const reviewsAvg = document.getElementById('reviewsAvg').value;

            const url = `https://localhost:7005/api/Books?seed=${seed}&region=${region}&page=${currentPage}&likesAvg=${likesAvg}&reviewsAvg=${reviewsAvg}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                let tbody;
                if (currentPage === 1) {
                    document.getElementById('results').innerHTML = `
                <div class="table-scroll">
                  <table class="table table-bordered table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>#</th>
                        <th>ISBN</th>
                        <th>Title</th>
                        <th>Authors</th>
                        <th>Publisher</th>
                      </tr>
                    </thead>
                    <tbody id="bookRows"></tbody>
                  </table>
                  <div id="scroll-trigger"></div>
                </div>
              `;
                    tbody = document.getElementById('bookRows');
                    attachObserver();
                } else {
                    tbody = document.getElementById('bookRows');
                }

                data.forEach((book, i) => {
                    const globalId = `book-${(currentPage - 1) * 20 + i}`;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td><a href="#" class="row-trigger" data-id="${globalId}">${(currentPage - 1) * 20 + i + 1}</a></td>
                <td><a href="#" class="row-trigger" data-id="${globalId}">${book.isbn}</a></td>
                <td><a href="#" class="row-trigger" data-id="${globalId}">${book.title}</a></td>
                <td><a href="#" class="row-trigger" data-id="${globalId}">${book.authors.join(', ')}</a></td>
                <td><a href="#" class="row-trigger" data-id="${globalId}">${book.publisher}</a></td>
              `;
                    tbody.appendChild(row);

                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'details-row';
                    detailsRow.dataset.id = globalId;
                    detailsRow.innerHTML = `
                <td colspan="5">
                  <div class="details-container d-flex gap-4">
                    <div class="book-cover" style="background-color: ${stringToColor(book.title)};">
                      <div class="cover-text">
                        <h5>${book.title}</h5>
                        <p>${book.authors.join(', ')}</p>
                      </div>
                    </div>
                    <div>
                      <p><strong>🏷 Genre:</strong> ${book.genre || 'Unknown'}</p>
                      <p><strong>📖 Description:</strong> ${book.description || 'No description'}</p>
                      <p><strong><i class="fa-solid fa-heart" style="color: #ff0000;"></i> Likes:</strong> ${book.likes}</p>
                      <p><strong>📝 Reviews:</strong> ${book.reviews.length}</p>
                      ${book.reviews.length > 0
                            ? book.reviews.map(r => `
                          <div class="review">
                            <em>${r.author}</em> <small>(${new Date(r.date).toLocaleDateString()})</small><br>
                            <span>${r.text}</span>
                            <div class="rating">⭐ ${r.rating}/5</div>
                          </div>`).join('')
                            : '<div class="no-reviews">No reviews</div>'
                        }
                    </div>
                  </div>
                </td>
              `;
                    tbody.appendChild(detailsRow);
                });

                currentPage++;
            } catch (error) {
                document.getElementById('results').innerHTML = `<p class="text-danger">Ошибка загрузки: ${error}</p>`;
            } finally {
                isLoading = false;
            }
        }

        function attachObserver() {
            const trigger = document.getElementById('scroll-trigger');
            const scrollContainer = document.querySelector('.table-scroll');
            if (!trigger || !scrollContainer) return;

            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    loadBooks();
                }
            }, {
                root: scrollContainer,
                rootMargin: '100px',
                threshold: 0.1
            });

            observer.observe(trigger);
        }

        document.getElementById('generateBtn').addEventListener('click', () => {
            currentPage = 1;
            document.getElementById('results').innerHTML = '';
            loadBooks();
        });

        function toggleDetails(e) {
            const link = e.target.closest('.row-trigger');
            if (!link) return;

            e.preventDefault(); 

            const id = link.dataset.id;
            const detailsRow = document.querySelector(`.details-row[data-id="${id}"]`);
            if (detailsRow) {
     
                detailsRow.style.display = (detailsRow.style.display === 'none' || detailsRow.style.display === '')
                    ? 'table-row'
                    : 'none';
            }
        }

        document.addEventListener('click', toggleDetails);

      
        document.addEventListener('touchstart', toggleDetails, { passive: false });

        // colorbook
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }
    </script>
</body>
</html>
